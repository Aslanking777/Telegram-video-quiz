<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Telegram Interactive Video Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Telegram Mini Apps JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #050509;
      --bg-soft: #121219;
      --accent: #2a9d8f;
      --accent-soft: #1f6f65;
      --danger: #e76f51;
      --text: #f5f5f5;
      --text-muted: #9fa4b8;
      --border: #262738;
      --overlay-bg: rgba(0, 0, 0, 0.78);
      --button-radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 600px;
      margin: 0 auto;
      background: var(--bg);
    }

    header {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(5, 5, 9, 0.98);
      backdrop-filter: blur(10px);
    }

    header h1 {
      font-size: 16px;
      font-weight: 600;
    }

    header .mode-toggle {
      display: flex;
      gap: 6px;
      background: var(--bg-soft);
      padding: 4px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-muted);
      user-select: none;
      white-space: nowrap;
    }

    .pill.active {
      background: var(--accent);
      color: #ffffff;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Layout: top video, bottom panels */
    .video-container {
      width: 100%;
      background: #000;
      position: relative;
      aspect-ratio: 16 / 9;
      flex-shrink: 0;
    }

    video {
      width: 100%;
      height: 100%;
      background: #000;
      display: block;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg-soft);
    }

    .tab {
      flex: 1;
      padding: 8px 0;
      text-align: center;
      font-size: 13px;
      cursor: pointer;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      color: var(--text);
      border-bottom-color: var(--accent);
    }

    .panel {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px 12px;
      display: none;
    }

    .panel.active {
      display: block;
    }

    /* Video list */
    .video-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .video-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: var(--bg-soft);
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor: pointer;
    }

    .video-card.selected {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, rgba(42, 157, 143, 0.25), var(--bg-soft));
    }

    .video-thumb {
      width: 72px;
      height: 42px;
      border-radius: 8px;
      background: #000;
      position: relative;
      flex-shrink: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 11px;
      border: 1px solid #222;
    }

    .video-thumb span {
      padding: 2px 4px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 4px;
    }

    .video-info {
      flex: 1;
      min-width: 0;
    }

    .video-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .video-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .video-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .btn-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
    }

    .btn-icon.danger {
      border-color: rgba(231, 111, 81, 0.6);
      color: var(--danger);
    }

    /* Buttons and inputs */
    .btn {
      width: 100%;
      padding: 10px 14px;
      margin-top: 8px;
      border-radius: var(--button-radius);
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      color: #ffffff;
      background: var(--accent);
    }

    .btn.secondary {
      background: var(--bg-soft);
      color: var(--text);
      border: 1px solid var(--border);
    }

    label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: block;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      background: #050509;
      color: var(--text);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 9px;
      font-size: 13px;
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 50px;
      max-height: 110px;
    }

    input::placeholder,
    textarea::placeholder {
      color: #565a6b;
    }

    .field-row {
      margin-bottom: 8px;
    }

    .field-row.inline {
      display: flex;
      gap: 8px;
    }

    .field-row.inline > div {
      flex: 1;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-top: 6px;
      margin-bottom: 3px;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 5px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    /* Question list */
    .question-list {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .question-item {
      border-radius: 10px;
      padding: 6px 8px;
      background: var(--bg-soft);
      border: 1px solid var(--border);
      font-size: 12px;
    }

    .question-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .question-time {
      font-weight: 600;
      font-size: 11px;
      color: var(--accent);
    }

    .question-actions {
      display: flex;
      gap: 4px;
    }

    .badge {
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .option-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .option-pill {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-muted);
    }

    .option-pill.correct {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Quiz overlay */
    .quiz-overlay {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      top: 0;
      background: transparent;
      pointer-events: none;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 20;
      transition: background 0.25s ease;
    }

    .quiz-overlay.active {
      background: var(--overlay-bg);
      pointer-events: auto;
    }

    .quiz-panel {
      width: 100%;
      max-width: 600px;
      background: rgba(12, 13, 20, 0.98);
      backdrop-filter: blur(14px);
      border-radius: 16px 16px 0 0;
      padding: 12px 12px 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      transform: translateY(100%);
      transition: transform 0.38s cubic-bezier(0.4, 0.0, 0.2, 1);
      box-shadow: 0 -12px 24px rgba(0, 0, 0, 0.6);
    }

    .quiz-overlay.active .quiz-panel {
      transform: translateY(0%);
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .quiz-title {
      font-size: 13px;
      font-weight: 600;
    }

    .quiz-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .quiz-question {
      font-size: 14px;
      margin: 4px 0 10px;
    }

    .blank {
      border-bottom: 1px dashed rgba(255, 255, 255, 0.4);
      padding: 0 3px;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    .quiz-option {
      width: 100%;
      text-align: left;
      padding: 10px 10px;
      border-radius: var(--button-radius);
      border: 1px solid var(--border);
      background: rgba(9, 9, 15, 0.9);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quiz-option-label {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .quiz-option-text {
      flex: 1;
    }

    .quiz-option.correct {
      background: rgba(42, 157, 143, 0.16);
      border-color: rgba(42, 157, 143, 0.9);
    }

    .quiz-option.incorrect {
      background: rgba(231, 111, 81, 0.16);
      border-color: rgba(231, 111, 81, 0.9);
    }

    .quiz-option.selected .quiz-option-label {
      border-color: #ffffff;
      color: #ffffff;
    }

    .quiz-explanation {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: none;
    }

    .quiz-explanation.visible {
      display: block;
    }

    .quiz-footer {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .quiz-footer .btn {
      margin-top: 0;
    }

    .quiz-footer .btn.secondary {
      font-size: 12px;
    }

    /* Small utility */
    .muted {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 4px;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 8px 0;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    /* Mobile scrollbar */
    .panel::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .panel {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Admin alert */
    .admin-badge {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    @media (min-width: 640px) {
      .app {
        border-left: 1px solid #111;
        border-right: 1px solid #111;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Video Quiz</h1>
    <div class="mode-toggle">
      <div class="pill active" id="pill-play">Play</div>
      <div class="pill" id="pill-admin" style="display: none;">Manage</div>
    </div>
  </header>

  <main>
    <div class="video-container">
      <video id="player" playsinline webkit-playsinline controls></video>
    </div>

    <div class="content">
      <div class="tabs" id="tabs-play">
        <div class="tab active" data-tab="play-list">Videos</div>
        <div class="tab" data-tab="play-details">Questions</div>
      </div>
      <div class="tabs" id="tabs-admin" style="display:none">
        <div class="tab active" data-tab="admin-videos">Videos</div>
        <div class="tab" data-tab="admin-questions">Questions</div>
      </div>

      <!-- Play mode panels -->
      <div class="panel active" id="panel-play-list">
        <div class="section-title">Available videos</div>
        <p class="hint">Select a video to start the interactive quiz.</p>
        <div id="play-video-list" class="video-list"></div>
      </div>
      <div class="panel" id="panel-play-details">
        <div class="section-title">Questions for this video</div>
        <p class="hint">Timed questions will appear automatically while watching.</p>
        <div id="play-question-list" class="question-list"></div>
      </div>

      <!-- Admin mode panels -->
      <div class="panel" id="panel-admin-videos">
        <div class="section-title">Upload / Add video</div>
        <p class="admin-badge"><span class="dot"></span> Admin mode: changes are saved locally.</p>

        <div class="field-row">
          <label for="video-title-input">Title</label>
          <input id="video-title-input" type="text" placeholder="Short title (e.g. Lesson 1 â€“ Networking)" />
        </div>

        <div class="field-row inline">
          <div>
            <label for="video-url-input">Video URL (MP4)</label>
            <input id="video-url-input" type="text" placeholder="https://... .mp4" />
          </div>
        </div>
        <p class="hint">
          On GitHub Pages / Netlify, place small MP4 files in the same folder and use a relative path like <code>lesson1.mp4</code>.
        </p>

        <button id="add-video-btn" class="btn">Add / Update Video</button>

        <div class="divider"></div>

        <div class="section-title">All videos</div>
        <p class="hint">Tap a video to select it for editing questions.</p>
        <div id="admin-video-list" class="video-list"></div>
      </div>

      <div class="panel" id="panel-admin-questions">
        <div class="section-title">Questions for selected video</div>
        <p class="hint" id="admin-selected-video-label">No video selected yet.</p>

        <div id="question-editor">
          <div class="field-row inline">
            <div>
              <label for="trigger-time-input">Trigger time (seconds)</label>
              <input id="trigger-time-input" type="number" min="0" step="0.1" placeholder="e.g. 12.0" />
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="chips">
                <span class="chip" id="use-current-time-chip">Use current video time</span>
              </div>
            </div>
          </div>

          <div class="field-row">
            <label for="question-text-input">Question (use _____ for blank)</label>
            <textarea id="question-text-input" placeholder="The district has just implemented a new, comprehensive _____ on all of your nodes."></textarea>
          </div>

          <div class="section-title">Options</div>
          <p class="hint">Mark exactly one option as correct.</p>

          <div class="field-row">
            <label>Option 1</label>
            <div class="field-row inline">
              <div><input id="opt1-input" type="text" placeholder="education system" /></div>
              <div style="flex:0 0 auto;display:flex;align-items:center;gap:4px;">
                <input type="radio" name="correct-option" id="opt1-correct" value="0" />
                <label for="opt1-correct" style="margin:0;font-size:11px;">Correct</label>
              </div>
            </div>
          </div>

          <div class="field-row">
            <label>Option 2</label>
            <div class="field-row inline">
              <div><input id="opt2-input" type="text" placeholder="program" /></div>
              <div style="flex:0 0 auto;display:flex;align-items:center;gap:4px;">
                <input type="radio" name="correct-option" id="opt2-correct" value="1" />
                <label for="opt2-correct" style="margin:0;font-size:11px;">Correct</label>
              </div>
            </div>
          </div>

          <div class="field-row">
            <label>Option 3</label>
            <div class="field-row inline">
              <div><input id="opt3-input" type="text" placeholder="policy" /></div>
              <div style="flex:0 0 auto;display:flex;align-items:center;gap:4px;">
                <input type="radio" name="correct-option" id="opt3-correct" value="2" />
                <label for="opt3-correct" style="margin:0;font-size:11px;">Correct</label>
              </div>
            </div>
          </div>

          <div class="field-row">
            <label>Option 4</label>
            <div class="field-row inline">
              <div><input id="opt4-input" type="text" placeholder="curriculum" /></div>
              <div style="flex:0 0 auto;display:flex;align-items:center;gap:4px;">
                <input type="radio" name="correct-option" id="opt4-correct" value="3" />
                <label for="opt4-correct" style="margin:0;font-size:11px;">Correct</label>
              </div>
            </div>
          </div>

          <div class="field-row">
            <label for="explanation-input">Explanation</label>
            <textarea id="explanation-input" placeholder="A district can implement a curriculum, which defines what is taught. Systems and policies operate at different levels."></textarea>
          </div>

          <div class="field-row inline">
            <button id="save-question-btn" class="btn">Add question</button>
            <button id="reset-question-form-btn" class="btn secondary">Reset form</button>
          </div>

          <input type="hidden" id="editing-question-id" value="" />
        </div>

        <div class="divider"></div>

        <div class="section-title">Existing questions</div>
        <div id="admin-question-list" class="question-list"></div>
      </div>
    </div>
  </main>
</div>

<!-- Quiz overlay -->
<div class="quiz-overlay" id="quiz-overlay">
  <div class="quiz-panel">
    <div class="quiz-header">
      <div class="quiz-title">Quick check</div>
      <div class="quiz-time" id="quiz-time-label"></div>
    </div>
    <div class="quiz-question" id="quiz-question-text"></div>
    <div class="quiz-options" id="quiz-options"></div>
    <div class="quiz-explanation" id="quiz-explanation"></div>
    <div class="quiz-footer">
      <button class="btn secondary" id="quiz-skip-btn">Skip</button>
      <button class="btn" id="quiz-continue-btn" disabled>Continue</button>
    </div>
  </div>
</div>

<script>
  // ==============================
  // Telegram Mini App integration
  // ==============================
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  if (tg) {
    tg.ready(); // Tell Telegram the Mini App is ready to be displayed. [web:16]
    tg.expand(); // Try to occupy maximum height. [web:4][web:13]
    try {
      tg.setHeaderColor('secondary_bg_color');
      tg.setBackgroundColor('#050509');
    } catch (e) {}
  }

  function hapticLightImpact() {
    if (!tg || !tg.HapticFeedback) return;
    try {
      tg.HapticFeedback.impactOccurred('light');
    } catch (e) {}
  }

  // ==============================
  // Data model & storage
  // ==============================
  /**
   * All data is stored locally using localStorage.
   * In a real production bot, you can swap this for Telegram's SecureStorage or a backend. [web:4][web:9]
   *
   * Schema:
   * videos = [
   * {
   * id: string,
   * title: string,
   * url: string,
   * questions: [
   * {
   * id: string,
   * triggerTime: number,
   * questionText: string,
   * options: string[4],
   * correctIndex: 0-3,
   * explanation: string
   * }
   * ]
   * }
   * ]
   */
  const STORAGE_KEY = 'tg_video_quiz_v1';

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // Seed with example video config (no video URL by default)
        return { videos: [] };
      }
      return JSON.parse(raw);
    } catch (e) {
      return { videos: [] };
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // Currently selected video ID (for play & admin)
  let selectedVideoId = state.videos[0] ? state.videos[0].id : null;

  // ==============================
  // DOM references
  // ==============================
  const player = document.getElementById('player');

  const pillPlay = document.getElementById('pill-play');
  const pillAdmin = document.getElementById('pill-admin');

  const tabsPlay = document.getElementById('tabs-play');
  const tabsAdmin = document.getElementById('tabs-admin');

  const panelPlayList = document.getElementById('panel-play-list');
  const panelPlayDetails = document.getElementById('panel-play-details');
  const panelAdminVideos = document.getElementById('panel-admin-videos');
  const panelAdminQuestions = document.getElementById('panel-admin-questions');

  const playVideoList = document.getElementById('play-video-list');
  const playQuestionList = document.getElementById('play-question-list');
  const adminVideoList = document.getElementById('admin-video-list');
  const adminQuestionList = document.getElementById('admin-question-list');

  const videoTitleInput = document.getElementById('video-title-input');
  const videoUrlInput = document.getElementById('video-url-input');
  const addVideoBtn = document.getElementById('add-video-btn');

  const adminSelectedVideoLabel = document.getElementById('admin-selected-video-label');

  const triggerTimeInput = document.getElementById('trigger-time-input');
  const useCurrentTimeChip = document.getElementById('use-current-time-chip');
  const questionTextInput = document.getElementById('question-text-input');
  const opt1Input = document.getElementById('opt1-input');
  const opt2Input = document.getElementById('opt2-input');
  const opt3Input = document.getElementById('opt3-input');
  const opt4Input = document.getElementById('opt4-input');
  const explanationInput = document.getElementById('explanation-input');
  const saveQuestionBtn = document.getElementById('save-question-btn');
  const resetQuestionFormBtn = document.getElementById('reset-question-form-btn');
  const editingQuestionIdInput = document.getElementById('editing-question-id');
  const correctRadioInputs = document.querySelectorAll('input[name="correct-option"]');

  // Quiz overlay elements
  const quizOverlay = document.getElementById('quiz-overlay');
  const quizTimeLabel = document.getElementById('quiz-time-label');
  const quizQuestionText = document.getElementById('quiz-question-text');
  const quizOptions = document.getElementById('quiz-options');
  const quizExplanation = document.getElementById('quiz-explanation');
  const quizSkipBtn = document.getElementById('quiz-skip-btn');
  const quizContinueBtn = document.getElementById('quiz-continue-btn');

  // ==============================
  // Helper functions
  // ==============================
  function uid() {
    return 'id_' + Math.random().toString(36).substr(2, 9);
  }

  function formatTime(seconds) {
    const s = Math.floor(seconds % 60);
    const m = Math.floor(seconds / 60);
    return m + ':' + (s < 10 ? '0' + s : s);
  }

  function getSelectedVideo() {
    return state.videos.find(v => v.id === selectedVideoId) || null;
  }

  function setSelectedVideo(id) {
    selectedVideoId = id;
    const v = getSelectedVideo();
    if (v) {
      // Load into <video>
      player.src = v.url || '';
      player.load();
      adminSelectedVideoLabel.textContent = 'Editing: ' + v.title;
    } else {
      player.removeAttribute('src');
      player.load();
      adminSelectedVideoLabel.textContent = 'No video selected.';
    }
    clearQuizState();
    renderAll();
  }

  // ==============================
  // Rendering
  // ==============================
  function renderVideoLists() {
    // Play list
    playVideoList.innerHTML = '';
    if (!state.videos.length) {
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = 'No videos yet. Switch to Manage and add your first video.';
      playVideoList.appendChild(p);
    } else {
      state.videos.forEach(v => {
        const card = document.createElement('div');
        card.className = 'video-card' + (v.id === selectedVideoId ? ' selected' : '');
        card.addEventListener('click', () => {
          hapticLightImpact();
          setSelectedVideo(v.id);
        });

        const thumb = document.createElement('div');
        thumb.className = 'video-thumb';
        const sp = document.createElement('span');
        sp.textContent = 'MP4';
        thumb.appendChild(sp);

        const info = document.createElement('div');
        info.className = 'video-info';
        const title = document.createElement('div');
        title.className = 'video-title';
        title.textContent = v.title || 'Untitled video';
        const meta = document.createElement('div');
        meta.className = 'video-meta';
        const qCount = v.questions ? v.questions.length : 0;
        meta.textContent = qCount + ' question' + (qCount === 1 ? '' : 's');
        info.appendChild(title);
        info.appendChild(meta);

        card.appendChild(thumb);
        card.appendChild(info);

        playVideoList.appendChild(card);
      });
    }

    // Admin list
    adminVideoList.innerHTML = '';
    if (!state.videos.length) {
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = 'No videos yet. Use the form above to add one.';
      adminVideoList.appendChild(p);
    } else {
      state.videos.forEach(v => {
        const card = document.createElement('div');
        card.className = 'video-card' + (v.id === selectedVideoId ? ' selected' : '');
        card.addEventListener('click', () => {
          hapticLightImpact();
          setSelectedVideo(v.id);
          // Prefill title/url
          videoTitleInput.value = v.title;
          videoUrlInput.value = v.url;
        });

        const thumb = document.createElement('div');
        thumb.className = 'video-thumb';
        const sp = document.createElement('span');
        sp.textContent = 'MP4';
        thumb.appendChild(sp);

        const info = document.createElement('div');
        info.className = 'video-info';
        const title = document.createElement('div');
        title.className = 'video-title';
        title.textContent = v.title || 'Untitled video';
        const meta = document.createElement('div');
        meta.className = 'video-meta';
        const qCount = v.questions ? v.questions.length : 0;
        meta.textContent = qCount + ' question' + (qCount === 1 ? '' : 's');
        info.appendChild(title);
        info.appendChild(meta);

        const acts = document.createElement('div');
        acts.className = 'video-actions';

        const playBtn = document.createElement('button');
        playBtn.className = 'btn-icon';
        playBtn.innerHTML = 'â–¶';
        playBtn.title = 'Play';
        playBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          hapticLightImpact();
          setSelectedVideo(v.id);
          player.play().catch(() => {});
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-icon danger';
        delBtn.innerHTML = 'Ã—';
        delBtn.title = 'Delete';
        delBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!confirm('Delete this video and all its questions?')) return;
          state.videos = state.videos.filter(x => x.id !== v.id);
          if (selectedVideoId === v.id) {
            selectedVideoId = state.videos[0] ? state.videos[0].id : null;
          }
          saveState();
          setSelectedVideo(selectedVideoId);
        });

        acts.appendChild(playBtn);
        acts.appendChild(delBtn);

        card.appendChild(thumb);
        card.appendChild(info);
        card.appendChild(acts);

        adminVideoList.appendChild(card);
      });
    }
  }

  function renderQuestionsLists() {
    const v = getSelectedVideo();

    // Play view
    playQuestionList.innerHTML = '';
    if (!v || !v.questions || !v.questions.length) {
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = v ? 'No questions yet for this video.' : 'Select a video to see its questions.';
      playQuestionList.appendChild(p);
    } else {
      const sorted = [...v.questions].sort((a, b) => a.triggerTime - b.triggerTime);
      sorted.forEach(q => {
        const item = document.createElement('div');
        item.className = 'question-item';

        const header = document.createElement('div');
        header.className = 'question-item-header';

        const time = document.createElement('div');
        time.className = 'question-time';
        time.textContent = 'At ' + q.triggerTime.toFixed(1) + 's';

        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = 'MCQ';

        header.appendChild(time);
        header.appendChild(badge);

        const text = document.createElement('div');
        text.style.marginBottom = '3px';
        text.textContent = q.questionText;

        const optionsRow = document.createElement('div');
        optionsRow.className = 'option-row';
        q.options.forEach((opt, idx) => {
          const pill = document.createElement('div');
          pill.className = 'option-pill' + (idx === q.correctIndex ? ' correct' : '');
          pill.textContent = opt;
          optionsRow.appendChild(pill);
        });

        item.appendChild(header);
        item.appendChild(text);
        item.appendChild(optionsRow);

        playQuestionList.appendChild(item);
      });
    }

    // Admin view
    adminQuestionList.innerHTML = '';
    if (!v) {
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = 'Select a video above to manage its questions.';
      adminQuestionList.appendChild(p);
      return;
    }

    if (!v.questions || !v.questions.length) {
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = 'No questions yet. Use the form above to add one.';
      adminQuestionList.appendChild(p);
      return;
    }

    const sorted = [...v.questions].sort((a, b) => a.triggerTime - b.triggerTime);
    sorted.forEach(q => {
      const item = document.createElement('div');
      item.className = 'question-item';

      const header = document.createElement('div');
      header.className = 'question-item-header';

      const time = document.createElement('div');
      time.className = 'question-time';
      time.textContent = '@ ' + q.triggerTime.toFixed(1) + 's';

      const actions = document.createElement('div');
      actions.className = 'question-actions';
      const editBtn = document.createElement('button');
      editBtn.className = 'btn-icon';
      editBtn.innerHTML = 'âœŽ';
      editBtn.title = 'Edit';
      editBtn.addEventListener('click', () => {
        populateQuestionFormForEdit(q);
      });
      const delBtn = document.createElement('button');
      delBtn.className = 'btn-icon danger';
      delBtn.innerHTML = 'Ã—';
      delBtn.title = 'Delete';
      delBtn.addEventListener('click', () => {
        if (!confirm('Delete this question?')) return;
        v.questions = v.questions.filter(x => x.id !== q.id);
        saveState();
        renderQuestionsLists();
      });
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);

      header.appendChild(time);
      header.appendChild(actions);

      const text = document.createElement('div');
      text.style.marginBottom = '3px';
      text.textContent = q.questionText;

      const optionsRow = document.createElement('div');
      optionsRow.className = 'option-row';
      q.options.forEach((opt, idx) => {
        const pill = document.createElement('div');
        pill.className = 'option-pill' + (idx === q.correctIndex ? ' correct' : '');
        pill.textContent = opt;
        optionsRow.appendChild(pill);
      });

      item.appendChild(header);
      item.appendChild(text);
      item.appendChild(optionsRow);

      adminQuestionList.appendChild(item);
    });
  }

  function renderAll() {
    renderVideoLists();
    renderQuestionsLists();
  }

  // ==============================
  // Admin: add/update video
  // ==============================
  addVideoBtn.addEventListener('click', () => {
    hapticLightImpact();
    const title = videoTitleInput.value.trim() || 'Untitled video';
    const url = videoUrlInput.value.trim();
    if (!url) {
      alert('Please provide a video URL (MP4).');
      return;
    }

    // If a video with same URL exists, update it (title, keep questions)
    let existing = state.videos.find(v => v.url === url);
    if (existing) {
      existing.title = title;
      alert('Updated existing video.');
      selectedVideoId = existing.id;
    } else {
      const v = {
        id: uid(),
        title,
        url,
        questions: []
      };
      state.videos.push(v);
      selectedVideoId = v.id;
      alert('Added new video.');
    }
    saveState();
    setSelectedVideo(selectedVideoId);
  });

  // ==============================
  // Admin: question form handling
  // ==============================
  function resetQuestionForm() {
    triggerTimeInput.value = '';
    questionTextInput.value = '';
    opt1Input.value = '';
    opt2Input.value = '';
    opt3Input.value = '';
    opt4Input.value = '';
    explanationInput.value = '';
    correctRadioInputs.forEach(r => r.checked = false);
    editingQuestionIdInput.value = '';
    saveQuestionBtn.textContent = 'Add question';
  }

  resetQuestionFormBtn.addEventListener('click', () => {
    hapticLightImpact();
    resetQuestionForm();
  });

  useCurrentTimeChip.addEventListener('click', () => {
    const t = player.currentTime || 0;
    triggerTimeInput.value = t.toFixed(1);
  });

  function populateQuestionFormForEdit(q) {
    triggerTimeInput.value = q.triggerTime.toFixed(1);
    questionTextInput.value = q.questionText;
    opt1Input.value = q.options[0] || '';
    opt2Input.value = q.options[1] || '';
    opt3Input.value = q.options[2] || '';
    opt4Input.value = q.options[3] || '';
    explanationInput.value = q.explanation || '';
    correctRadioInputs.forEach(r => {
      r.checked = parseInt(r.value, 10) === q.correctIndex;
    });
    editingQuestionIdInput.value = q.id;
    saveQuestionBtn.textContent = 'Save changes';
    // Switch to admin questions tab if not already
    switchToAdmin();
    setAdminTab('admin-questions');
  }

  saveQuestionBtn.addEventListener('click', () => {
    hapticLightImpact();
    const v = getSelectedVideo();
    if (!v) {
      alert('Select or create a video first.');
      return;
    }
    const tVal = parseFloat(triggerTimeInput.value);
    if (isNaN(tVal) || tVal < 0) {
      alert('Invalid trigger time.');
      return;
    }
    const qText = questionTextInput.value.trim();
    if (!qText) {
      alert('Enter the question text.');
      return;
    }
    const options = [
      opt1Input.value.trim(),
      opt2Input.value.trim(),
      opt3Input.value.trim(),
      opt4Input.value.trim()
    ];
    if (options.some(o => !o)) {
      alert('Fill in all four options.');
      return;
    }
    let correctIndex = -1;
    correctRadioInputs.forEach(r => {
      if (r.checked) correctIndex = parseInt(r.value, 10);
    });
    if (correctIndex < 0) {
      alert('Select the correct option.');
      return;
    }
    const explanation = explanationInput.value.trim();

    const editingId = editingQuestionIdInput.value;
    if (editingId) {
      // Update existing
      const existing = v.questions.find(q => q.id === editingId);
      if (existing) {
        existing.triggerTime = tVal;
        existing.questionText = qText;
        existing.options = options;
        existing.correctIndex = correctIndex;
        existing.explanation = explanation;
      }
    } else {
      // New question
      v.questions.push({
        id: uid(),
        triggerTime: tVal,
        questionText: qText,
        options,
        correctIndex,
        explanation
      });
    }
    saveState();
    resetQuestionForm();
    renderQuestionsLists();
  });

  // ==============================
  // Mode & tab switching
  // ==============================
  function setPlayTab(tabId) {
    const panels = {
      'play-list': panelPlayList,
      'play-details': panelPlayDetails
    };
    document.querySelectorAll('#tabs-play .tab').forEach(t => {
      if (t.dataset.tab === tabId) t.classList.add('active');
      else t.classList.remove('active');
    });
    Object.keys(panels).forEach(k => {
      panels[k].classList.toggle('active', k === tabId.split('play-')[1] || 'play-' + k === tabId);
    });
    panelPlayList.classList.toggle('active', tabId === 'play-list');
    panelPlayDetails.classList.toggle('active', tabId === 'play-details');
  }

  function setAdminTab(tabId) {
    const panels = {
      'admin-videos': panelAdminVideos,
      'admin-questions': panelAdminQuestions
    };
    document.querySelectorAll('#tabs-admin .tab').forEach(t => {
      if (t.dataset.tab === tabId) t.classList.add('active');
      else t.classList.remove('active');
    });
    panelAdminVideos.classList.toggle('active', tabId === 'admin-videos');
    panelAdminQuestions.classList.toggle('active', tabId === 'admin-questions');
  }

  tabsPlay.addEventListener('click', (e) => {
    const tab = e.target.closest('.tab');
    if (!tab) return;
    const id = tab.dataset.tab;
    if (id === 'play-list') setPlayTab('play-list');
    if (id === 'play-details') setPlayTab('play-details');
  });

  tabsAdmin.addEventListener('click', (e) => {
    const tab = e.target.closest('.tab');
    if (!tab) return;
    const id = tab.dataset.tab;
    if (id === 'admin-videos') setAdminTab('admin-videos');
    if (id === 'admin-questions') setAdminTab('admin-questions');
  });

  function switchToPlay() {
    pillPlay.classList.add('active');
    pillAdmin.classList.remove('active');
    tabsPlay.style.display = 'flex';
    tabsAdmin.style.display = 'none';
    panelPlayList.classList.add('active');
    panelPlayDetails.classList.remove('active');
    panelAdminVideos.classList.remove('active');
    panelAdminQuestions.classList.remove('active');
  }

  function switchToAdmin() {
    pillPlay.classList.remove('active');
    pillAdmin.classList.add('active');
    tabsPlay.style.display = 'none';
    tabsAdmin.style.display = 'flex';
    panelAdminVideos.classList.add('active');
    panelAdminQuestions.classList.remove('active');
    panelPlayList.classList.remove('active');
    panelPlayDetails.classList.remove('active');
  }

  pillPlay.addEventListener('click', () => {
    hapticLightImpact();
    switchToPlay();
  });

  pillAdmin.addEventListener('click', () => {
    hapticLightImpact();
    switchToAdmin();
  });

  // ==============================
  // Quiz runtime
  // ==============================
  /**
   * We compute the "next question" on each timeupdate and trigger it when
   * currentTime >= triggerTime and it wasn't shown before.
   *
   * For each play session, we track which question IDs were already shown.
   */
  let shownQuestionIds = new Set();
  let activeQuestion = null;

  function clearQuizState() {
    shownQuestionIds = new Set();
    activeQuestion = null;
    hideQuizOverlay();
  }

  function getNextQuestionForTime(t) {
    const v = getSelectedVideo();
    if (!v || !v.questions || !v.questions.length) return null;
    const candidates = v.questions
      .filter(q => !shownQuestionIds.has(q.id) && q.triggerTime <= t + 0.05) // small epsilon
      .sort((a, b) => a.triggerTime - b.triggerTime);
    return candidates[0] || null;
  }

  function showQuizOverlay(q) {
    if (!q) return;
    activeQuestion = q;
    shownQuestionIds.add(q.id);

    quizTimeLabel.textContent = '@ ' + q.triggerTime.toFixed(1) + 's';
    // Highlight the blank visually inside the question.
    const htmlQuestion = q.questionText.replace('_____', '<span class="blank">_____</span>');
    quizQuestionText.innerHTML = htmlQuestion;

    quizOptions.innerHTML = '';
    const labels = ['A', 'B', 'C', 'D'];
    q.options.forEach((opt, idx) => {
      const btn = document.createElement('button');
      btn.className = 'quiz-option';
      btn.dataset.index = idx;

      const lab = document.createElement('div');
      lab.className = 'quiz-option-label';
      lab.textContent = labels[idx];

      const txt = document.createElement('div');
      txt.className = 'quiz-option-text';
      txt.textContent = opt;

      btn.appendChild(lab);
      btn.appendChild(txt);

      btn.addEventListener('click', () => {
        hapticLightImpact();
        handleQuizOptionSelected(idx);
      });

      quizOptions.appendChild(btn);
    });

    quizExplanation.textContent = q.explanation || '';
    quizExplanation.classList.remove('visible');
    quizContinueBtn.disabled = true;

    quizOverlay.classList.add('active');
  }

  function hideQuizOverlay() {
    quizOverlay.classList.remove('active');
  }

  function handleQuizOptionSelected(idx) {
    if (!activeQuestion) return;
    const correctIdx = activeQuestion.correctIndex;

    const btns = Array.from(quizOptions.querySelectorAll('.quiz-option'));
    btns.forEach((b, i) => {
      b.classList.remove('selected', 'correct', 'incorrect');
      if (i === idx) b.classList.add('selected');
      if (i === correctIdx) b.classList.add('correct');
      if (i === idx && idx !== correctIdx) b.classList.add('incorrect');
    });

    quizExplanation.classList.add('visible');
    quizContinueBtn.disabled = false;
  }

  quizSkipBtn.addEventListener('click', () => {
    hapticLightImpact();
    hideQuizOverlay();
    // Do not mark as answered; question is considered seen but skipped.
  });

  quizContinueBtn.addEventListener('click', () => {
    hapticLightImpact();
    hideQuizOverlay();
    // Resume video
    player.play().catch(() => {});
  });

  // Pause and open overlay at correct time.
  player.addEventListener('timeupdate', () => {
    if (quizOverlay.classList.contains('active')) return;
    const t = player.currentTime || 0;
    const q = getNextQuestionForTime(t);
    if (q) {
      player.pause();
      showQuizOverlay(q);
    }
  });

  // Reset per-video state when the source changes
  player.addEventListener('loadedmetadata', () => {
    clearQuizState();
  });

   // ==============================
  // Initial render
  // ==============================
  if (selectedVideoId) {
    setSelectedVideo(selectedVideoId);
  } else {
    renderAll();
  }

  // ðŸ” ADMIN CHECK - Add your Telegram username here (e.g. @yourusername)
  const ADMIN_USERNAMES = ['@oxforddropout']; // â† Ð—ÐÐœÐ•ÐÐ˜ ÐÐ Ð¡Ð’ÐžÐ™!
  
  // Check if current user is admin
  if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && ADMIN_USERNAMES.includes('@' + tg.initDataUnsafe.user.username)) {
    document.getElementById('pill-admin').style.display = 'block';
  }

  pillAdmin.addEventListener('click', () => {
    if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user || !ADMIN_USERNAMES.includes('@' + tg.initDataUnsafe.user.username)) {
      alert('Admin access required. Contact the owner.');
      return;
    }
    hapticLightImpact();
    switchToAdmin();
  });

</script>
</body>
</html>