<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Interactive Video Quiz - Backend Version</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #050509;
            --bg-soft: #121219;
            --accent: #2a9d8f;
            --accent-soft: #1f6f65;
            --danger: #e76f51;
            --text: #f5f5f5;
            --text-muted: #9fa4b8;
            --border: #262738;
            --overlay-bg: rgba(0, 0, 0, 0.78);
            --button-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg);
        }

        header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(5, 5, 9, 0.98);
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-size: 16px;
            font-weight: 600;
        }

        header .mode-toggle {
            display: flex;
            gap: 6px;
            background: var(--bg-soft);
            padding: 4px;
            border-radius: 999px;
            border: 1px solid var(--border);
        }

        .pill {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-muted);
            user-select: none;
            white-space: nowrap;
        }

        .pill.active {
            background: var(--accent);
            color: #ffffff;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .video-container {
            width: 100%;
            background: #000;
            position: relative;
            aspect-ratio: 16 / 9;
            flex-shrink: 0;
        }

        video {
            width: 100%;
            height: 100%;
            background: #000;
            display: block;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-soft);
        }

        .tab {
            flex: 1;
            padding: 8px 0;
            text-align: center;
            font-size: 13px;
            cursor: pointer;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: var(--text);
            border-bottom-color: var(--accent);
        }

        .panel {
            flex: 1;
            overflow-y: auto;
            padding: 10px 12px 12px;
            display: none;
        }

        .panel.active {
            display: block;
        }

        .video-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .video-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-soft);
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .video-card.selected {
            border-color: var(--accent);
            background: radial-gradient(circle at top left, rgba(42, 157, 143, 0.25), var(--bg-soft));
        }

        .video-thumb {
            width: 72px;
            height: 42px;
            border-radius: 8px;
            background: #000;
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 11px;
            border: 1px solid #222;
        }

        .video-thumb span {
            padding: 2px 4px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
        }

        .video-info {
            flex: 1;
            min-width: 0;
        }

        .video-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .video-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .btn-icon {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
        }

        .btn-icon.danger {
            border-color: rgba(231, 111, 81, 0.6);
            color: var(--danger);
        }

        .btn {
            width: 100%;
            padding: 10px 14px;
            margin-top: 8px;
            border-radius: var(--button-radius);
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: #ffffff;
            background: var(--accent);
        }

        .btn.secondary {
            background: var(--bg-soft);
            color: var(--text);
            border: 1px solid var(--border);
        }

        label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
            display: block;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            background: #050509;
            color: var(--text);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 8px 9px;
            font-size: 13px;
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 50px;
            max-height: 110px;
        }

        input::placeholder,
        textarea::placeholder {
            color: #565a6b;
        }

        .field-row {
            margin-bottom: 8px;
        }

        .field-row.inline {
            display: flex;
            gap: 8px;
        }

        .field-row.inline > div {
            flex: 1;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            margin-top: 6px;
            margin-bottom: 3px;
        }

        .hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 5px;
        }

        .chip {
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .question-list {
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .question-item {
            border-radius: 10px;
            padding: 6px 8px;
            background: var(--bg-soft);
            border: 1px solid var(--border);
            font-size: 12px;
        }

        .question-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .question-time {
            font-weight: 600;
            font-size: 11px;
            color: var(--accent);
        }

        .question-actions {
            display: flex;
            gap: 4px;
        }

        .badge {
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .option-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 2px;
        }

        .option-pill {
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-muted);
        }

        .option-pill.correct {
            border-color: var(--accent);
            color: var(--accent);
        }

        .quiz-overlay {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            top: 0;
            background: transparent;
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 20;
            transition: background 0.25s ease;
        }

        .quiz-overlay.active {
            background: var(--overlay-bg);
            pointer-events: auto;
        }

        .quiz-panel {
            width: 100%;
            max-width: 600px;
            background: rgba(12, 13, 20, 0.98);
            backdrop-filter: blur(14px);
            border-radius: 16px 16px 0 0;
            padding: 12px 12px 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            transform: translateY(100%);
            transition: transform 0.38s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 -12px 24px rgba(0, 0, 0, 0.6);
        }

        .quiz-overlay.active .quiz-panel {
            transform: translateY(0%);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .quiz-title {
            font-size: 13px;
            font-weight: 600;
        }

        .quiz-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .quiz-question {
            font-size: 14px;
            margin: 4px 0 10px;
        }

        .blank {
            border-bottom: 1px dashed rgba(255, 255, 255, 0.4);
            padding: 0 3px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .quiz-option {
            width: 100%;
            text-align: left;
            padding: 10px 10px;
            border-radius: var(--button-radius);
            border: 1px solid var(--border);
            background: rgba(9, 9, 15, 0.9);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quiz-option-label {
            width: 20px;
            height: 20px;
            border-radius: 999px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .quiz-option-text {
            flex: 1;
        }

        .quiz-option.correct {
            background: rgba(42, 157, 143, 0.16);
            border-color: rgba(42, 157, 143, 0.9);
        }

        .quiz-option.incorrect {
            background: rgba(231, 111, 81, 0.16);
            border-color: rgba(231, 111, 81, 0.9);
        }

        .quiz-option.selected .quiz-option-label {
            border-color: #ffffff;
            color: #ffffff;
        }

        .quiz-explanation {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: none;
        }

        .quiz-explanation.visible {
            display: block;
        }

        .quiz-footer {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .quiz-footer .btn {
            margin-top: 0;
        }

        .quiz-footer .btn.secondary {
            font-size: 12px;
        }

        .muted {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 4px;
        }

        .divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }

        .admin-badge {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--accent);
        }

        .panel::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .panel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @media (min-width: 640px) {
            .app {
                border-left: 1px solid #111;
                border-right: 1px solid #111;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <header>
        <h1>Video Quiz</h1>
        <div class="mode-toggle">
            <div class="pill active" id="pill-play">Play</div>
            <div class="pill" id="pill-admin" style="display: none;">Manage</div>
        </div>
    </header>

    <main>
        <div class="video-container">
            <video id="player" playsinline webkit-playsinline controls></video>
        </div>

        <div class="content">
            <div class="tabs" id="tabs-play">
                <div class="tab active" data-tab="play-list">Videos</div>
            </div>
            <div class="tabs" id="tabs-admin" style="display:none">
                <div class="tab active" data-tab="admin-videos">Videos</div>
                <div class="tab" data-tab="admin-questions">Questions</div>
            </div>

            <div class="panel active" id="panel-play-list">
                <div class="section-title">Available videos</div>
                <p class="hint">Select a video to start the interactive quiz.</p>
                <div id="play-video-list" class="video-list"></div>
            </div>

            <div class="panel" id="panel-admin-videos">
                <div class="section-title">Upload / Add video</div>
                <p class="admin-badge"><span class="dot"></span> Firebase Cloud: Videos saved here are visible to ALL users instantly.</p>

                <div class="field-row">
                    <label for="video-title-input">Title</label>
                    <input id="video-title-input" type="text" placeholder="Short title (e.g. Lesson 1 – Networking)" />
                </div>

                <div class="field-row inline">
                    <div>
                        <label for="video-url-input">Video URL (MP4)</label>
                        <input id="video-url-input" type="text" placeholder="https://... .mp4" />
                    </div>
                </div>
                <p class="hint">Use Netlify, Cloudflare R2, or GitHub for MP4 hosting.</p>

                <button id="add-video-btn" class="btn">Add / Update Video</button>

                <div class="divider"></div>

                <div class="section-title">All videos</div>
                <p class="hint">Tap a video to select it for editing questions.</p>
                <div id="admin-video-list" class="video-list"></div>
            </div>

            <div class="panel" id="panel-admin-questions">
                <div class="section-title">Questions for selected video</div>
                <p class="hint" id="admin-selected-video-label">No video selected yet.</p>

                <div id="question-editor">
                    <div class="field-row inline">
                        <div>
                            <label for="trigger-time-input">Trigger time (seconds)</label>
                            <input id="trigger-time-input" type="number" min="0" step="0.1" placeholder="e.g. 12.0" />
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <div class="chips">
                                <span class="chip" id="use-current-time-chip">Use current video time</span>
                            </div>
                        </div>
                    </div>

                    <div class="field-row">
                        <label for="question-text-input">Question (use _____ for blank)</label>
                        <textarea id="question-text-input" placeholder="The district has just implemented a new, comprehensive _____ on all of your nodes."></textarea>
                    </div>

                    <div class="section-title">Options</div>
                    <p class="hint">Mark exactly one option as correct.</p>

                    <div class="field-row">
                        <label>Option 1</label>
                        <div class="field-row inline">
                            <div><input id="opt1-input" type="text" placeholder="education system" /></div>
                            <div style="flex:0 0 auto;display:flex;align-items:center;gap:4px;">
                                <input type="radio" name="correct-option" id="opt1-correct" value="0" />
                                <label for="opt1-correct" style="margin:0;font-size:11px;">Correct</label>
                            </div>
                        </div>
                    </div>

                    <div class="field-row">
                        <label>Option 2</label>
                        <div class="field-row inline">
                            <div><input id="opt2-input" type="text" placeholder="program" /></div>
                            <div style="flex:0 0 auto;display:flex;align-items:center;gap:4px;">
                                <input type="radio" name="correct-option" id="opt2-correct" value="1" />
                                <label for="opt2-correct" style="margin:0;font-size:11px;">Correct</label>
                            </div>
                        </div>
                    </div>

                    <div class="field-row">
                        <label>Option 3</label>
                        <div class="field-row inline">
                            <div><input id="opt3-input" type="text" placeholder="policy" /></div>
                            <div style="flex:0 0 auto;display:flex;align-items:center;gap:4px;">
                                <input type="radio" name="correct-option" id="opt3-correct" value="2" />
                                <label for="opt3-correct" style="margin:0;font-size:11px;">Correct</label>
                            </div>
                        </div>
                    </div>

                    <div class="field-row">
                        <label>Option 4</label>
                        <div class="field-row inline">
                            <div><input id="opt4-input" type="text" placeholder="curriculum" /></div>
                            <div style="flex:0 0 auto;display:flex;align-items:center;gap:4px;">
                                <input type="radio" name="correct-option" id="opt4-correct" value="3" />
                                <label for="opt4-correct" style="margin:0;font-size:11px;">Correct</label>
                            </div>
                        </div>
                    </div>

                    <div class="field-row">
                        <label for="explanation-input">Explanation</label>
                        <textarea id="explanation-input" placeholder="Curriculum = учебный план."></textarea>
                    </div>

                    <div class="field-row inline">
                        <button id="save-question-btn" class="btn">Add question</button>
                        <button id="reset-question-form-btn" class="btn secondary">Reset form</button>
                    </div>

                    <input type="hidden" id="editing-question-id" value="" />
                </div>

                <div class="divider"></div>

                <div class="section-title">Existing questions</div>
                <div id="admin-question-list" class="question-list"></div>
            </div>
        </div>
    </main>
</div>

<div class="quiz-overlay" id="quiz-overlay">
    <div class="quiz-panel">
        <div class="quiz-header">
            <div class="quiz-title">Quick check</div>
            <div class="quiz-time" id="quiz-time-label"></div>
        </div>
        <div class="quiz-question" id="quiz-question-text"></div>
        <div class="quiz-options" id="quiz-options"></div>
        <div class="quiz-explanation" id="quiz-explanation"></div>
        <div class="quiz-footer">
            <button class="btn secondary" id="quiz-skip-btn">Skip</button>
            <button class="btn" id="quiz-continue-btn" disabled>Continue</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script>
// ==============================
// FIREBASE CONFIG
// ==============================
const firebaseConfig = {
  apiKey: "AIzaSyD5pUVWBMr5Cp_YB33XY3ovaGwV7pVx73k",
  authDomain: "deepquiz-bc4e8.firebaseapp.com",
  projectId: "deepquiz-bc4e8",
  storageBucket: "deepquiz-bc4e8.firebasestorage.app",
  messagingSenderId: "507418915969",
  appId: "1:507418915969:web:780e0263afa3fffae70980",
  measurementId: "G-FYD9G5SYQF"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const ADMIN_USERNAMES = ['@Oxforddropout'];

// ==============================
// Telegram Mini App integration
// ==============================
const tg = window.Telegram?.WebApp || null;

if (tg) {
    tg.ready();
    tg.expand();
    try {
        tg.setHeaderColor('secondary_bg_color');
        tg.setBackgroundColor('#050509');
    } catch (e) {}
}

function hapticLightImpact() {
    if (!tg || !tg.HapticFeedback) return;
    try {
        tg.HapticFeedback.impactOccurred('light');
    } catch (e) {}
}

// ==============================
// Backend: Firebase Firestore
// ==============================
async function loadFromBackend() {
    try {
        const snapshot = await db.collection('videos').get();
        const videos = [];
        snapshot.forEach(doc => {
            videos.push({ id: doc.id, ...doc.data() });
        });
        return { videos };
    } catch (e) {
        console.error('Firebase load failed:', e);
        return { videos: [] };
    }
}

async function saveVideoToBackend(video) {
    if (!isAdmin()) {
        alert('❌ Only admin can save');
        return false;
    }

    try {
        if (video.id && video.id.startsWith('id_')) {
            const docRef = await db.collection('videos').add({
                title: video.title,
                url: video.url,
                questions: video.questions || []
            });
            video.id = docRef.id;
        } else if (video.id) {
            await db.collection('videos').doc(video.id).set({
                title: video.title,
                url: video.url,
                questions: video.questions || []
            });
        }
        return true;
    } catch (e) {
        console.error('Firebase save failed:', e);
        alert('❌ Save failed: ' + e.message);
        return false;
    }
}

async function deleteVideoFromBackend(videoId) {
    if (!isAdmin()) {
        alert('❌ Only admin can delete');
        return false;
    }

    try {
        await db.collection('videos').doc(videoId).delete();
        return true;
    } catch (e) {
        console.error('Firebase delete failed:', e);
        alert('❌ Delete failed: ' + e.message);
        return false;
    }
}

function isAdmin() {
    return tg && tg.initDataUnsafe?.user?.username && 
           ADMIN_USERNAMES.includes('@' + tg.initDataUnsafe.user.username);
}

// ==============================
// Data model & storage
// ==============================
let state = { videos: [] };
let selectedVideoId = null;

async function loadState() {
    state = await loadFromBackend();
    if (state.videos && state.videos.length > 0) {
        selectedVideoId = state.videos[0].id;
    }
}

async function saveState() {
    await loadState();
}

// ==============================
// DOM references
// ==============================
const player = document.getElementById('player');
const pillPlay = document.getElementById('pill-play');
const pillAdmin = document.getElementById('pill-admin');
const tabsPlay = document.getElementById('tabs-play');
const tabsAdmin = document.getElementById('tabs-admin');
const panelPlayList = document.getElementById('panel-play-list');
const panelAdminVideos = document.getElementById('panel-admin-videos');
const panelAdminQuestions = document.getElementById('panel-admin-questions');
const playVideoList = document.getElementById('play-video-list');
const adminVideoList = document.getElementById('admin-video-list');
const videoTitleInput = document.getElementById('video-title-input');
const videoUrlInput = document.getElementById('video-url-input');
const addVideoBtn = document.getElementById('add-video-btn');
const adminSelectedVideoLabel = document.getElementById('admin-selected-video-label');
const triggerTimeInput = document.getElementById('trigger-time-input');
const useCurrentTimeChip = document.getElementById('use-current-time-chip');
const questionTextInput = document.getElementById('question-text-input');
const opt1Input = document.getElementById('opt1-input');
const opt2Input = document.getElementById('opt2-input');
const opt3Input = document.getElementById('opt3-input');
const opt4Input = document.getElementById('opt4-input');
const explanationInput = document.getElementById('explanation-input');
const saveQuestionBtn = document.getElementById('save-question-btn');
const resetQuestionFormBtn = document.getElementById('reset-question-form-btn');
const editingQuestionIdInput = document.getElementById('editing-question-id');
const correctRadioInputs = document.querySelectorAll('input[name="correct-option"]');
const adminQuestionList = document.getElementById('admin-question-list');
const quizOverlay = document.getElementById('quiz-overlay');
const quizTimeLabel = document.getElementById('quiz-time-label');
const quizQuestionText = document.getElementById('quiz-question-text');
const quizOptions = document.getElementById('quiz-options');
const quizExplanation = document.getElementById('quiz-explanation');
const quizSkipBtn = document.getElementById('quiz-skip-btn');
const quizContinueBtn = document.getElementById('quiz-continue-btn');

// ==============================
// Helper functions
// ==============================
function uid() {
    return 'id_' + Math.random().toString(36).substr(2, 9);
}

function formatTime(seconds) {
    const s = Math.floor(seconds % 60);
    const m = Math.floor(seconds / 60);
    return m + ':' + (s < 10 ? '0' + s : s);
}

function getSelectedVideo() {
    return state.videos.find(v => v.id === selectedVideoId) || null;
}

function setSelectedVideo(id) {
    selectedVideoId = id;
    const v = getSelectedVideo();
    if (v) {
        player.src = v.url || '';
        player.load();
        adminSelectedVideoLabel.textContent = 'Editing: ' + v.title;
    } else {
        player.removeAttribute('src');
        player.load();
        adminSelectedVideoLabel.textContent = 'No video selected.';
    }
    clearQuizState();
    renderAll();
}

// ==============================
// Rendering
// ==============================
function renderVideoLists() {
    playVideoList.innerHTML = '';
    if (!state.videos.length) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'No videos yet. Contact admin to add videos.';
        playVideoList.appendChild(p);
    } else {
        state.videos.forEach(v => {
            const card = document.createElement('div');
            card.className = 'video-card' + (v.id === selectedVideoId ? ' selected' : '');
            card.addEventListener('click', () => {
                hapticLightImpact();
                setSelectedVideo(v.id);
            });

            const thumb = document.createElement('div');
            thumb.className = 'video-thumb';
            const sp = document.createElement('span');
            sp.textContent = 'MP4';
            thumb.appendChild(sp);

            const info = document.createElement('div');
            info.className = 'video-info';
            const title = document.createElement('div');
            title.className = 'video-title';
            title.textContent = v.title || 'Untitled video';
            const meta = document.createElement('div');
            meta.className = 'video-meta';
            const qCount = v.questions ? v.questions.length : 0;
            meta.textContent = qCount + ' question' + (qCount === 1 ? '' : 's');
            info.appendChild(title);
            info.appendChild(meta);

            card.appendChild(thumb);
            card.appendChild(info);

            playVideoList.appendChild(card);
        });
    }

    adminVideoList.innerHTML = '';
    if (!state.videos.length) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'No videos yet. Use the form above to add one.';
        adminVideoList.appendChild(p);
    } else {
        state.videos.forEach(v => {
            const card = document.createElement('div');
            card.className = 'video-card' + (v.id === selectedVideoId ? ' selected' : '');
            card.addEventListener('click', () => {
                hapticLightImpact();
                setSelectedVideo(v.id);
                videoTitleInput.value = v.title;
                videoUrlInput.value = v.url;
            });

            const thumb = document.createElement('div');
            thumb.className = 'video-thumb';
            const sp = document.createElement('span');
            sp.textContent = 'MP4';
            thumb.appendChild(sp);

            const info = document.createElement('div');
            info.className = 'video-info';
            const title = document.createElement('div');
            title.className = 'video-title';
            title.textContent = v.title || 'Untitled video';
            const meta = document.createElement('div');
            meta.className = 'video-meta';
            const qCount = v.questions ? v.questions.length : 0;
            meta.textContent = qCount + ' question' + (qCount === 1 ? '' : 's');
            info.appendChild(title);
            info.appendChild(meta);

            const acts = document.createElement('div');
            acts.className = 'video-actions';

            const playBtn = document.createElement('button');
            playBtn.className = 'btn-icon';
            playBtn.innerHTML = '▶';
            playBtn.title = 'Play';
            playBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                hapticLightImpact();
                setSelectedVideo(v.id);
                player.play().catch(() => {});
            });

            const delBtn = document.createElement('button');
            delBtn.className = 'btn-icon danger';
            delBtn.innerHTML = '×';
            delBtn.title = 'Delete';
            delBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!confirm('Delete this video and all its questions?')) return;
                
                const success = await deleteVideoFromBackend(v.id);
                if (success) {
                    state.videos = state.videos.filter(x => x.id !== v.id);
                    if (selectedVideoId === v.id) {
                        selectedVideoId = state.videos[0] ? state.videos[0].id : null;
                    }
                    await loadState();
                    setSelectedVideo(selectedVideoId);
                }
            });

            acts.appendChild(playBtn);
            acts.appendChild(delBtn);

            card.appendChild(thumb);
            card.appendChild(info);
            card.appendChild(acts);

            adminVideoList.appendChild(card);
        });
    }
}

function renderQuestionsLists() {
    const v = getSelectedVideo();

    adminQuestionList.innerHTML = '';
    if (!v) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'Select a video above to manage its questions.';
        adminQuestionList.appendChild(p);
        return;
    }

    if (!v.questions || !v.questions.length) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'No questions yet. Use the form above to add one.';
        adminQuestionList.appendChild(p);
        return;
    }

    const sorted = [...v.questions].sort((a, b) => a.triggerTime - b.triggerTime);
    sorted.forEach(q => {
        const item = document.createElement('div');
        item.className = 'question-item';

        const header = document.createElement('div');
        header.className = 'question-item-header';

        const time = document.createElement('div');
        time.className = 'question-time';
        time.textContent = '@ ' + q.triggerTime.toFixed(1) + 's';

        const actions = document.createElement('div');
        actions.className = 'question-actions';
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-icon';
        editBtn.innerHTML = '✎';
        editBtn.title = 'Edit';
        editBtn.addEventListener('click', () => {
            populateQuestionFormForEdit(q);
        });
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-icon danger';
        delBtn.innerHTML = '×';
        delBtn.title = 'Delete';
        delBtn.addEventListener('click', async () => {
            if (!confirm('Delete this question?')) return;
            v.questions = v.questions.filter(x => x.id !== q.id);
            await saveVideoToBackend(v);
            await loadState();
            renderQuestionsLists();
        });
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        header.appendChild(time);
        header.appendChild(actions);

        const text = document.createElement('div');
        text.style.marginBottom = '3px';
        text.textContent = q.questionText;

        const optionsRow = document.createElement('div');
        optionsRow.className = 'option-row';
        q.options.forEach((opt, idx) => {
            const pill = document.createElement('div');
            pill.className = 'option-pill' + (idx === q.correctIndex ? ' correct' : '');
            pill.textContent = opt;
            optionsRow.appendChild(pill);
        });

        item.appendChild(header);
        item.appendChild(text);
        item.appendChild(optionsRow);

        adminQuestionList.appendChild(item);
    });
}

function renderAll() {
    renderVideoLists();
    renderQuestionsLists();
}

// ==============================
// Admin: add/update video
// ==============================
addVideoBtn.addEventListener('click', async () => {
    hapticLightImpact();
    addVideoBtn.disabled = true;
    addVideoBtn.textContent = 'Saving...';
    
    const title = videoTitleInput.value.trim() || 'Untitled video';
    const url = videoUrlInput.value.trim();
    if (!url) {
        alert('Please provide a video URL (MP4).');
        addVideoBtn.disabled = false;
        addVideoBtn.textContent = 'Add / Update Video';
        return;
    }

    let existing = state.videos.find(v => v.url === url);
    if (existing) {
        existing.title = title;
        const success = await saveVideoToBackend(existing);
        if (success) {
            alert('✅ Updated existing video.');
            selectedVideoId = existing.id;
        }
    } else {
        const v = {
            id: uid(),
            title,
            url,
            questions: []
        };
        const success = await saveVideoToBackend(v);
        if (success) {
            state.videos.push(v);
            selectedVideoId = v.id;
            alert('✅ Added new video.');
        }
    }
    
    await loadState();
    setSelectedVideo(selectedVideoId);
    addVideoBtn.disabled = false;
    addVideoBtn.textContent = 'Add / Update Video';
});

// ==============================
// Admin: question form handling
// ==============================
function resetQuestionForm() {
    triggerTimeInput.value = '';
    questionTextInput.value = '';
    opt1Input.value = '';
    opt2Input.value = '';
    opt3Input.value = '';
    opt4Input.value = '';
    explanationInput.value = '';
    correctRadioInputs.forEach(r => r.checked = false);
    editingQuestionIdInput.value = '';
    saveQuestionBtn.textContent = 'Add question';
}

resetQuestionFormBtn.addEventListener('click', () => {
    hapticLightImpact();
    resetQuestionForm();
});

useCurrentTimeChip.addEventListener('click', () => {
    const t = player.currentTime || 0;
    triggerTimeInput.value = t.toFixed(1);
});

function populateQuestionFormForEdit(q) {
    triggerTimeInput.value = q.triggerTime.toFixed(1);
    questionTextInput.value = q.questionText;
    opt1Input.value = q.options[0] || '';
    opt2Input.value = q.options[1] || '';
    opt3Input.value = q.options[2] || '';
    opt4Input.value = q.options[3] || '';
    explanationInput.value = q.explanation || '';
    correctRadioInputs.forEach(r => {
        r.checked = parseInt(r.value, 10) === q.correctIndex;
    });
    editingQuestionIdInput.value = q.id;
    saveQuestionBtn.textContent = 'Save changes';
    switchToAdmin();
    setAdminTab('admin-questions');
}

saveQuestionBtn.addEventListener('click', async () => {
    hapticLightImpact();
    const v = getSelectedVideo();
    if (!v) {
        alert('Select or create a video first.');
        return;
    }
    
    saveQuestionBtn.disabled = true;
    saveQuestionBtn.textContent = 'Saving...';
    
    const tVal = parseFloat(triggerTimeInput.value);
    if (isNaN(tVal) || tVal < 0) {
        alert('Invalid trigger time.');
        saveQuestionBtn.disabled = false;
        saveQuestionBtn.textContent = editingQuestionIdInput.value ? 'Save changes' : 'Add question';
        return;
    }
    const qText = questionTextInput.value.trim();
    if (!qText) {
        alert('Enter the question text.');
        saveQuestionBtn.disabled = false;
        saveQuestionBtn.textContent = editingQuestionIdInput.value ? 'Save changes' : 'Add question';
        return;
    }
    const options = [
        opt1Input.value.trim(),
        opt2Input.value.trim(),
        opt3Input.value.trim(),
        opt4Input.value.trim()
    ];
    if (options.some(o => !o)) {
        alert('Fill in all four options.');
        saveQuestionBtn.disabled = false;
        saveQuestionBtn.textContent = editingQuestionIdInput.value ? 'Save changes' : 'Add question';
        return;
    }
    let correctIndex = -1;
    correctRadioInputs.forEach(r => {
        if (r.checked) correctIndex = parseInt(r.value, 10);
    });
    if (correctIndex < 0) {
        alert('Select the correct option.');
        saveQuestionBtn.disabled = false;
        saveQuestionBtn.textContent = editingQuestionIdInput.value ? 'Save changes' : 'Add question';
        return;
    }
    const explanation = explanationInput.value.trim();

    const editingId = editingQuestionIdInput.value;
    if (editingId) {
        const existing = v.questions.find(q => q.id === editingId);
        if (existing) {
            existing.triggerTime = tVal;
            existing.questionText = qText;
            existing.options = options;
            existing.correctIndex = correctIndex;
            existing.explanation = explanation;
        }
    } else {
        v.questions.push({
            id: uid(),
            triggerTime: tVal,
            questionText: qText,
            options,
            correctIndex,
            explanation
        });
    }
    
    await saveVideoToBackend(v);
    await loadState();
    resetQuestionForm();
    renderQuestionsLists();
    
    saveQuestionBtn.disabled = false;
    saveQuestionBtn.textContent = 'Add question';
});

// ==============================
// Mode & tab switching
// ==============================
function setAdminTab(tabId) {
    document.querySelectorAll('#tabs-admin .tab').forEach(t => {
        if (t.dataset.tab === tabId) t.classList.add('active');
        else t.classList.remove('active');
    });
    panelAdminVideos.classList.toggle('active', tabId === 'admin-videos');
    panelAdminQuestions.classList.toggle('active', tabId === 'admin-questions');
}

tabsAdmin.addEventListener('click', (e) => {
    const tab = e.target.closest('.tab');
    if (!tab) return;
    const id = tab.dataset.tab;
    if (id === 'admin-videos') setAdminTab('admin-videos');
    if (id === 'admin-questions') setAdminTab('admin-questions');
});

function switchToPlay() {
    pillPlay.classList.add('active');
    pillAdmin.classList.remove('active');
    tabsPlay.style.display = 'flex';
    tabsAdmin.style.display = 'none';
    panelPlayList.classList.add('active');
    panelAdminVideos.classList.remove('active');
    panelAdminQuestions.classList.remove('active');
}

function switchToAdmin() {
    pillPlay.classList.remove('active');
    pillAdmin.classList.add('active');
    tabsPlay.style.display = 'none';
    tabsAdmin.style.display = 'flex';
    panelAdminVideos.classList.add('active');
    panelAdminQuestions.classList.remove('active');
    panelPlayList.classList.remove('active');
}

pillPlay.addEventListener('click', () => {
    hapticLightImpact();
    switchToPlay();
});

pillAdmin.addEventListener('click', () => {
    hapticLightImpact();
    switchToAdmin();
});

// ==============================
// Quiz runtime
// ==============================
let shownQuestionIds = new Set();
let activeQuestion = null;

function clearQuizState() {
    shownQuestionIds = new Set();
    activeQuestion = null;
    hideQuizOverlay();
}

function getNextQuestionForTime(t) {
    const v = getSelectedVideo();
    if (!v || !v.questions || !v.questions.length) return null;
    const candidates = v.questions
        .filter(q => !shownQuestionIds.has(q.id) && q.triggerTime <= t + 0.05)
        .sort((a, b) => a.triggerTime - b.triggerTime);
    return candidates[0] || null;
}

function showQuizOverlay(q) {
    if (!q) return;
    activeQuestion = q;
    shownQuestionIds.add(q.id);

    quizTimeLabel.textContent = '@ ' + q.triggerTime.toFixed(1) + 's';
    const htmlQuestion = q.questionText.replace('_____', '<span class="blank">_____</span>');
    quizQuestionText.innerHTML = htmlQuestion;

    quizOptions.innerHTML = '';
    const labels = ['A', 'B', 'C', 'D'];
    q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'quiz-option';
        btn.dataset.index = idx;

        const lab = document.createElement('div');
        lab.className = 'quiz-option-label';
        lab.textContent = labels[idx];

        const txt = document.createElement('div');
        txt.className = 'quiz-option-text';
        txt.textContent = opt;

        btn.appendChild(lab);
        btn.appendChild(txt);

        btn.addEventListener('click', () => {
            hapticLightImpact();
            handleQuizOptionSelected(idx);
        });

        quizOptions.appendChild(btn);
    });

    quizExplanation.textContent = q.explanation || '';
    quizExplanation.classList.remove('visible');
    quizContinueBtn.disabled = true;

    quizOverlay.classList.add('active');
}

function hideQuizOverlay() {
    quizOverlay.classList.remove('active');
}

function handleQuizOptionSelected(idx) {
    if (!activeQuestion) return;
    const correctIdx = activeQuestion.correctIndex;

    const btns = Array.from(quizOptions.querySelectorAll('.quiz-option'));
    btns.forEach((b, i) => {
        b.classList.remove('selected', 'correct', 'incorrect');
        if (i === idx) b.classList.add('selected');
        if (i === correctIdx) b.classList.add('correct');
        if (i === idx && idx !== correctIdx) b.classList.add('incorrect');
    });

    quizExplanation.classList.add('visible');
    quizContinueBtn.disabled = false;
}

quizSkipBtn.addEventListener('click', () => {
    hapticLightImpact();
    hideQuizOverlay();
});

quizContinueBtn.addEventListener('click', () => {
    hapticLightImpact();
    hideQuizOverlay();
    player.play().catch(() => {});
});

player.addEventListener('timeupdate', () => {
    if (quizOverlay.classList.contains('active')) return;
    const t = player.currentTime || 0;
    const q = getNextQuestionForTime(t);
    if (q) {
        player.pause();
        showQuizOverlay(q);
    }
});

player.addEventListener('loadedmetadata', () => {
    clearQuizState();
});

// ==============================
// Admin check
// ==============================
if (isAdmin()) {
    document.getElementById('pill-admin').style.display = 'block';
}

// ==============================
// Initial load
// ==============================
(async () => {
    await loadState();
    if (selectedVideoId) {
        setSelectedVideo(selectedVideoId);
    } else {
        renderAll();
    }
})();
</script>
</body>
</html>
